From 8fb7a0afcc255f853035e08819abdb69a52df2e1 Mon Sep 17 00:00:00 2001
From: Zenon Mousmoulas <zmousm@noc.grnet.gr>
Date: Tue, 29 May 2018 15:25:54 +0300
Subject: [PATCH 1/3] munin-cgi-graph: only remove rendered graphs if
 QUERY_STRING present

---
 master/_bin/munin-cgi-graph.in | 5 ++++-
 1 file changed, 4 insertions(+), 1 deletion(-)

diff --git a/master/_bin/munin-cgi-graph.in b/master/_bin/munin-cgi-graph.in
index d9dc461f..99a27d6e 100755
--- a/master/_bin/munin-cgi-graph.in
+++ b/master/_bin/munin-cgi-graph.in
@@ -161,6 +161,7 @@ while (new CGI::Fast) {
     # If a "Cache-Control: no-cache" header gets send, we regenerate the image in every case:
     # Removed $pinpoint from the $no_cache expression - janl 2010-09-29
 
+    my $file_unlink;
     my $no_cache = defined($ENV{HTTP_CACHE_CONTROL}) &&
       $ENV{HTTP_CACHE_CONTROL} =~ /no-cache/i;
     # Be able to deactivate the cache with the url
@@ -171,6 +172,7 @@ while (new CGI::Fast) {
     # Having some QUERY_STRING disables the cache.
     if (defined($ENV{QUERY_STRING}) && $ENV{QUERY_STRING} ne "") {
       $no_cache = 1;
+      $file_unlink = 1;
     }
 
     # Compute the cache values
@@ -265,7 +267,8 @@ while (new CGI::Fast) {
 
     # If $no_cache, remove the file. No need to keep it anyway.
     # And it handles http://bugs.debian.org/668667
-    unlink($filename) if $no_cache;
+    # Revisited (zmousm 2018-05-28): unlink only if QUERY_STRING present
+    unlink($filename) if $file_unlink;
 
 } continue {
 	$nb_request++;
-- 
2.11.0

